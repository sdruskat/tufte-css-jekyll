<p>In this post weâ€™ll discuss some ways of doing feature selection within a Bayesian framework</p>

<p>Let \(y\) be a set of real-valued observations. The basic linear regression model can be decribed as</p>

\[y_t = \beta^Tx + \varepsilon_t\]

<p>Where \( \varepsilon \sim N\left(0, \sigma^2\right) \). This can be equivalently written:</p>

<p>\(y \sim N\left(\beta^Tx, \sigma^2\right)\).</p>

<p>We will first place a prior on \(\beta\), like:</p>

\[\beta_i \sim \left(\frac{\tau}{2}\right)^p \mathrm{exp}\left(-\tau \mid\beta\mid \right)\]

<p>Then we will use the horseshoe prior:</p>

\[\beta_i \sim N\left(0, \lambda_i\right)\]

\[\lambda_i \sim \mathrm{Cauchy}^+\left(0, \tau\right)\]

\[\tau \sim \mathrm{Cauchy}^+\left(0, 1\right)\]

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pymc3</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">import</span> <span class="n">theano</span>
<span class="kn">import</span> <span class="n">theano.tensor</span> <span class="k">as</span> <span class="n">T</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="sh">'</span><span class="s">ggplot</span><span class="sh">'</span><span class="p">)</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">from</span> <span class="n">pymc3_models.exc</span> <span class="kn">import</span> <span class="n">PyMC3ModelsError</span>
<span class="kn">from</span> <span class="n">pymc3_models.models</span> <span class="kn">import</span> <span class="n">BayesianModel</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BayesianLassoRegression</span><span class="p">(</span><span class="n">BayesianModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Linear Regression built using PyMC3.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">BayesianLassoRegression</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ppc</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Creates and returns the PyMC3 model.
        Note: The size of the shared variables must match the size of the training data. Otherwise, setting the shared variables later will raise an error. See http://docs.pymc.io/advanced_theano.html
        Returns
        ----------
        the PyMC3 model
        </span><span class="sh">"""</span>
        <span class="n">model_input</span> <span class="o">=</span> <span class="n">theano</span><span class="p">.</span><span class="nf">shared</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span><span class="p">]))</span>

        <span class="n">model_output</span> <span class="o">=</span> <span class="n">theano</span><span class="p">.</span><span class="nf">shared</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span><span class="p">))</span>

        <span class="n">self</span><span class="p">.</span><span class="n">shared_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">:</span> <span class="n">model_input</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">:</span> <span class="n">model_output</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Laplace</span><span class="p">(</span><span class="sh">'</span><span class="s">beta</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span><span class="p">))</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfNormal</span><span class="p">(</span><span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">beta</span><span class="p">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">model_output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inference_type</span><span class="o">=</span><span class="sh">'</span><span class="s">nuts</span><span class="sh">'</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inference_args</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">draws</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}):</span>
        <span class="sh">"""</span><span class="s">
        Train the Linear Regression model
        Parameters
        ----------
        X : numpy array, shape [n_samples, n_features]
        y : numpy array, shape [n_samples, ]
        inference_type : string, specifies which inference method to call. Defaults to </span><span class="sh">'</span><span class="s">advi</span><span class="sh">'</span><span class="s">. Currently, only </span><span class="sh">'</span><span class="s">advi</span><span class="sh">'</span><span class="s"> and </span><span class="sh">'</span><span class="s">nuts</span><span class="sh">'</span><span class="s"> are supported
        minibatch_size : number of samples to include in each minibatch for ADVI, defaults to None, so minibatch is not run by default
        inference_args : dict, arguments to be passed to the inference methods. Check the PyMC3 docs for permissable values. If no arguments are specified, default values will be set.
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span>

        <span class="n">self</span><span class="p">.</span><span class="n">inference_type</span> <span class="o">=</span> <span class="n">inference_type</span>

        <span class="k">if</span> <span class="n">y</span><span class="p">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_args</span><span class="p">:</span>
            <span class="n">inference_args</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_set_default_inference_args</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_model</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">minibatch_size</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span><span class="p">:</span>
                <span class="n">minibatches</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">shared_vars</span><span class="p">[</span><span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">]:</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Minibatch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">minibatch_size</span><span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">shared_vars</span><span class="p">[</span><span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">]:</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Minibatch</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">minibatch_size</span><span class="p">),</span>
                <span class="p">}</span>

                <span class="n">inference_args</span><span class="p">[</span><span class="sh">'</span><span class="s">more_replacements</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">minibatches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_set_shared_vars</span><span class="p">({</span><span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_inference</span><span class="p">(</span><span class="n">inference_type</span><span class="p">,</span> <span class="n">inference_args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Predicts values of new data with a trained Linear Regression model
        Parameters
        ----------
        X : numpy array, shape [n_samples, n_features]
        return_std : Boolean flag of whether to return standard deviations with mean values. Defaults to False.
        </span><span class="sh">"""</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">trace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">PyMC3ModelsError</span><span class="p">(</span><span class="sh">'</span><span class="s">Run fit on the model before predict.</span><span class="sh">'</span><span class="p">)</span>

        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_model</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_set_shared_vars</span><span class="p">({</span><span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)})</span>

        <span class="n">self</span><span class="p">.</span><span class="n">ppc</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample_ppc</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">cached_model</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">ppc</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ppc</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="nf">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">ppc</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Scores new data with a trained model.
        Parameters
        ----------
        X : numpy array, shape [n_samples, n_features]
        y : numpy array, shape [n_samples, ]
        </span><span class="sh">"""</span>

        <span class="k">return</span> <span class="nf">r2_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_prefix</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">inference_type</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">inference_type</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">num_pred</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">num_training_samples</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span>
        <span class="p">}</span>

        <span class="nf">super</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">save</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_prefix</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span> <span class="n">load_custom_params</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">inference_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">inference_type</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">num_pred</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">num_training_samples</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">HorseshoeRegression</span><span class="p">(</span><span class="n">BayesianModel</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Linear Regression built using PyMC3.
    </span><span class="sh">"""</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">HorseshoeRegression</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">ppc</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Creates and returns the PyMC3 model.
        Note: The size of the shared variables must match the size of the training data. Otherwise, setting the shared variables later will raise an error. See http://docs.pymc.io/advanced_theano.html
        Returns
        ----------
        the PyMC3 model
        </span><span class="sh">"""</span>
        <span class="n">model_input</span> <span class="o">=</span> <span class="n">theano</span><span class="p">.</span><span class="nf">shared</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span><span class="p">]))</span>

        <span class="n">model_output</span> <span class="o">=</span> <span class="n">theano</span><span class="p">.</span><span class="nf">shared</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span><span class="p">))</span>

        <span class="n">self</span><span class="p">.</span><span class="n">shared_vars</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">:</span> <span class="n">model_input</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">:</span> <span class="n">model_output</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="mi">25</span>
        <span class="k">with</span> <span class="n">model</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfNormal</span><span class="p">(</span><span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">tau_0</span> <span class="o">=</span> <span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">T</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span><span class="p">)</span>

            <span class="n">tau</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfCauchy</span><span class="p">(</span><span class="sh">'</span><span class="s">tau</span><span class="sh">'</span><span class="p">,</span> <span class="n">tau_0</span><span class="p">)</span>
            <span class="n">c2</span>  <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">InverseGamma</span><span class="p">(</span><span class="sh">'</span><span class="s">c2</span><span class="sh">'</span><span class="p">,</span> <span class="n">dof</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">dof</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ss</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfCauchy</span><span class="p">(</span><span class="sh">'</span><span class="s">lam</span><span class="sh">'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">l1</span> <span class="o">=</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">T</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">c2</span> <span class="o">+</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">lam</span> <span class="o">*</span> <span class="n">lam</span><span class="p">)</span>
            <span class="n">lam_d</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">/</span> <span class="n">l2</span>

            <span class="n">beta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">beta</span><span class="sh">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tau</span> <span class="o">*</span> <span class="n">lam_d</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">num_pred</span><span class="p">)</span>
            <span class="n">y_hat</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">model_input</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>

            <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">model_output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">inference_type</span><span class="o">=</span><span class="sh">'</span><span class="s">nuts</span><span class="sh">'</span><span class="p">,</span> <span class="n">minibatch_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inference_args</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">draws</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}):</span>
        <span class="sh">"""</span><span class="s">
        Train the Linear Regression model
        Parameters
        ----------
        X : numpy array, shape [n_samples, n_features]
        y : numpy array, shape [n_samples, ]
        inference_type : string, specifies which inference method to call. Defaults to </span><span class="sh">'</span><span class="s">advi</span><span class="sh">'</span><span class="s">. Currently, only </span><span class="sh">'</span><span class="s">advi</span><span class="sh">'</span><span class="s"> and </span><span class="sh">'</span><span class="s">nuts</span><span class="sh">'</span><span class="s"> are supported
        minibatch_size : number of samples to include in each minibatch for ADVI, defaults to None, so minibatch is not run by default
        inference_args : dict, arguments to be passed to the inference methods. Check the PyMC3 docs for permissable values. If no arguments are specified, default values will be set.
        </span><span class="sh">"""</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span>

        <span class="n">self</span><span class="p">.</span><span class="n">inference_type</span> <span class="o">=</span> <span class="n">inference_type</span>

        <span class="k">if</span> <span class="n">y</span><span class="p">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inference_args</span><span class="p">:</span>
            <span class="n">inference_args</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_set_default_inference_args</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_model</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">minibatch_size</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span><span class="p">:</span>
                <span class="n">minibatches</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">shared_vars</span><span class="p">[</span><span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">]:</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Minibatch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">minibatch_size</span><span class="p">),</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">shared_vars</span><span class="p">[</span><span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">]:</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Minibatch</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">minibatch_size</span><span class="p">),</span>
                <span class="p">}</span>

                <span class="n">inference_args</span><span class="p">[</span><span class="sh">'</span><span class="s">more_replacements</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">minibatches</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">_set_shared_vars</span><span class="p">({</span><span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">:</span> <span class="n">y</span><span class="p">})</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_inference</span><span class="p">(</span><span class="n">inference_type</span><span class="p">,</span> <span class="n">inference_args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Predicts values of new data with a trained Linear Regression model
        Parameters
        ----------
        X : numpy array, shape [n_samples, n_features]
        return_std : Boolean flag of whether to return standard deviations with mean values. Defaults to False.
        </span><span class="sh">"""</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">trace</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nc">PyMC3ModelsError</span><span class="p">(</span><span class="sh">'</span><span class="s">Run fit on the model before predict.</span><span class="sh">'</span><span class="p">)</span>

        <span class="n">num_samples</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">cached_model</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">create_model</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="nf">_set_shared_vars</span><span class="p">({</span><span class="sh">'</span><span class="s">model_input</span><span class="sh">'</span><span class="p">:</span> <span class="n">X</span><span class="p">,</span> <span class="sh">'</span><span class="s">model_output</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)})</span>

        <span class="n">self</span><span class="p">.</span><span class="n">ppc</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample_ppc</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">trace</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">cached_model</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">selfl</span><span class="p">.</span><span class="n">ppc</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">ppc</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="nf">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">ppc</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="nf">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        Scores new data with a trained model.
        Parameters
        ----------
        X : numpy array, shape [n_samples, n_features]
        y : numpy array, shape [n_samples, ]
        </span><span class="sh">"""</span>

        <span class="k">return</span> <span class="nf">r2_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_prefix</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sh">'</span><span class="s">inference_type</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">inference_type</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">num_pred</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span><span class="p">,</span>
            <span class="sh">'</span><span class="s">num_training_samples</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span>
        <span class="p">}</span>

        <span class="nf">super</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">save</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file_prefix</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nf">super</span><span class="p">(</span><span class="n">LinearRegression</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="n">file_prefix</span><span class="p">,</span> <span class="n">load_custom_params</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">inference_type</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">inference_type</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_pred</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">num_pred</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_training_samples</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="sh">'</span><span class="s">num_training_samples</span><span class="sh">'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Generate some sparse data to play with
</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">200</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_features</span><span class="p">)</span>
<span class="n">coef</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
<span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">n_features</span><span class="p">)</span>
<span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">shuffle</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
<span class="n">coef</span><span class="p">[</span><span class="n">inds</span><span class="p">[</span><span class="mi">10</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># sparsify coef
</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">coef</span><span class="p">)</span>

<span class="c1"># add noise
</span><span class="n">y</span> <span class="o">+=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>

<span class="c1"># Split data in train set and test set
</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">X</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:</span><span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:],</span> <span class="n">y</span><span class="p">[</span><span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_beta</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b_hat</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="sh">'</span><span class="s">k</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b_hat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">b_hat</span> <span class="o">+</span> <span class="n">std</span><span class="p">,</span> <span class="n">b_hat</span> <span class="o">-</span> <span class="n">std</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">make_data</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
    <span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">bernoulli</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sig_p</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="nf">bernoulli</span><span class="p">(</span><span class="n">sig_p</span><span class="p">).</span><span class="nf">rvs</span><span class="p">():</span>
            <span class="k">if</span> <span class="nf">bernoulli</span><span class="p">(</span><span class="mf">0.5</span><span class="p">).</span><span class="nf">rvs</span><span class="p">():</span>
                <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>

    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">X</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">f</span>

<span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">make_data</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mpl</span><span class="p">.</span><span class="nf">rc_context</span><span class="p">():</span>
    <span class="n">mpl</span><span class="p">.</span><span class="nf">rc</span><span class="p">(</span><span class="sh">'</span><span class="s">figure</span><span class="sh">'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">navy</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">original coefficients</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="2021-03-01-bayesian-feature-selection_files/2021-03-01-bayesian-feature-selection_5_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lasso</span> <span class="o">=</span> <span class="nc">BayesianLassoRegression</span><span class="p">()</span>
<span class="n">lasso</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">y_pred_lasso</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">r2_score_lasso</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">.</span><span class="nf">score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">lasso</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">r^2 on test data : %f</span><span class="sh">"</span> <span class="o">%</span> <span class="n">r2_score_lasso</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Multiprocess sampling (2 chains in 2 jobs)
NUTS: [sigma, beta]
Sampling 2 chains: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3000/3000 [04:20&lt;00:00, 10.81draws/s]
The chain reached the maximum tree depth. Increase max_treedepth, increase target_accept or reparameterize.
The chain reached the maximum tree depth. Increase max_treedepth, increase target_accept or reparameterize.
The estimated number of effective samples is smaller than 200 for some parameters.
100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2000/2000 [00:15&lt;00:00, 125.78it/s]

BayesianLassoRegression()
r^2 on test data : -0.003733
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">horse_lasso</span> <span class="o">=</span> <span class="nc">HorseshoeRegression</span><span class="p">()</span>
<span class="n">horse_lasso</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">y_pred_hlasso</span> <span class="o">=</span> <span class="n">horse_lasso</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">r2_score_hlasso</span> <span class="o">=</span> <span class="nf">r2_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred_hlasso</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">r^2 on test data : %f</span><span class="sh">"</span> <span class="o">%</span> <span class="n">r2_score_hlasso</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Multiprocess sampling (2 chains in 2 jobs)
NUTS: [beta, lam, c2, tau, sigma]
Sampling 2 chains: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 3000/3000 [01:37&lt;00:00, 30.67draws/s]
 47%|â–ˆâ–ˆâ–ˆâ–ˆâ–‹     | 934/2000 [00:07&lt;00:08, 120.36it/s]
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">mpl</span><span class="p">.</span><span class="nf">rc_context</span><span class="p">():</span>
    <span class="n">mpl</span><span class="p">.</span><span class="nf">rc</span><span class="p">(</span><span class="sh">'</span><span class="s">figure</span><span class="sh">'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">navy</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">original coefficients</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">lasso</span><span class="p">.</span><span class="n">trace</span><span class="p">.</span><span class="nf">get_values</span><span class="p">(</span><span class="sh">'</span><span class="s">beta</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">gold</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">original coefficients</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">horse_lasso</span><span class="p">.</span><span class="n">trace</span><span class="p">.</span><span class="nf">get_values</span><span class="p">(</span><span class="sh">'</span><span class="s">beta</span><span class="sh">'</span><span class="p">).</span><span class="nf">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">lightgreen</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">original coefficients</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">'</span><span class="s">best</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="2021-03-01-bayesian-feature-selection_files/2021-03-01-bayesian-feature-selection_8_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pymc3</span> <span class="kn">import</span> <span class="n">summary</span><span class="p">,</span> <span class="n">traceplot</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="n">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">pylab</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">matplotlib.dates</span> <span class="k">as</span> <span class="n">mdates</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">pymc3</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="n">arviz</span> <span class="k">as</span> <span class="n">az</span>

<span class="kn">from</span> <span class="n">pandas.plotting</span> <span class="kn">import</span> <span class="n">register_matplotlib_converters</span>
<span class="nf">register_matplotlib_converters</span><span class="p">()</span>

<span class="n">sns</span><span class="p">.</span><span class="nf">set_context</span><span class="p">(</span><span class="sh">"</span><span class="s">notebook</span><span class="sh">"</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="nf">set_style</span><span class="p">(</span><span class="sh">"</span><span class="s">darkgrid</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">passengers</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">passengers.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">'</span><span class="s">;</span><span class="sh">'</span><span class="p">)</span>
<span class="n">passengers</span><span class="p">[</span><span class="sh">'</span><span class="s">Passengers</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">passengers</span><span class="p">[</span><span class="sh">'</span><span class="s">Passengers</span><span class="sh">'</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">passengers</span><span class="p">[</span><span class="sh">'</span><span class="s">Month</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">passengers</span><span class="p">[</span><span class="sh">'</span><span class="s">Month</span><span class="sh">'</span><span class="p">])</span>
<span class="n">passengers</span><span class="p">.</span><span class="nf">set_index</span><span class="p">(</span><span class="sh">'</span><span class="s">Month</span><span class="sh">'</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">passengers</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x134a79d50&gt;
</code></pre></div></div>

<p><img src="2021-08-13-Structural%20Time%20Series%20in%20PyMC3_files/2021-08-13-Structural%20Time%20Series%20in%20PyMC3_1_1.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">passengers</span><span class="p">[</span><span class="sh">'</span><span class="s">Passengers</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>112.0
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">():</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">GaussianRandomWalk</span><span class="p">(</span><span class="sh">'</span><span class="s">delta</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">144</span><span class="p">,))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">GaussianRandomWalk</span><span class="p">(</span><span class="sh">'</span><span class="s">mu</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">143</span><span class="p">,),</span> <span class="n">observed</span><span class="o">=</span><span class="n">passengers</span><span class="p">[</span><span class="sh">'</span><span class="s">Passengers</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [delta]
</code></pre></div></div>

<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value="24000" class="" max="24000" style="width:300px; height:20px; vertical-align: middle;"></progress>
  100.00% [24000/24000 00:11&lt;00:00 Sampling 4 chains, 0 divergences]
</div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sampling 4 chains for 1_000 tune and 5_000 draw iterations (4_000 + 20_000 draws total) took 20 seconds.
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/tomkealy/opt/anaconda3/lib/python3.7/site-packages/arviz/data/io_pymc3.py:91: FutureWarning: Using `from_pymc3` without the model will be deprecated in a future release. Not using the model will return less accurate and less useful results. Make sure you use the model argument or call from_pymc3 within a model context.
  FutureWarning,
/Users/tomkealy/opt/anaconda3/lib/python3.7/site-packages/arviz/plots/traceplot.py:195: UserWarning: rcParams['plot.max_subplots'] (20) is smaller than the number of variables to plot (144), generating only 20 plots
  UserWarning,





array([[&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132062690&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13210eed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x134d33350&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1321ceed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13595a9d0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132154a90&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13229f650&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132384b50&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1323c2f90&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1324bc7d0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1324fcb50&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1325eaed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132639bd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132727cd0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132773850&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132862d10&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1328a6fd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13299d990&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1329e0c10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132ad8610&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132b1ad90&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132c08f50&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132c91a10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132d57ad0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132da6690&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132e96b50&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x132ed8f50&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x132fcf7d0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x133014b50&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x133101ed0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13314dbd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13323ccd0&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1332d0850&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x133395d10&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x1333d9fd0&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x1334cf990&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x133511c10&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x13360c610&gt;],
       [&lt;matplotlib.axes._subplots.AxesSubplot object at 0x13364cd90&gt;,
        &lt;matplotlib.axes._subplots.AxesSubplot object at 0x133739f50&gt;]],
      dtype=object)
</code></pre></div></div>

<p><img src="2021-08-13-Structural%20Time%20Series%20in%20PyMC3_files/2021-08-13-Structural%20Time%20Series%20in%20PyMC3_4_2.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plot_forecast</span><span class="p">(</span><span class="n">data_df</span><span class="p">,</span>
                  <span class="n">col_name</span><span class="p">,</span>
                  <span class="n">forecast_start</span><span class="p">,</span>
                  <span class="n">forecast_mean</span><span class="p">,</span> 
                  <span class="n">forecast_scale</span><span class="p">,</span> 
                  <span class="n">forecast_samples</span><span class="p">,</span>
                  <span class="n">title</span><span class="p">,</span> 
                  <span class="n">x_locator</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
                  <span class="n">x_formatter</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">Plot a forecast distribution against the </span><span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="s"> time series.</span><span class="sh">"""</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="p">.</span><span class="nf">color_palette</span><span class="p">()</span>
    <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">.</span><span class="n">index</span>

    <span class="n">num_steps</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_steps_forecast</span> <span class="o">=</span> <span class="n">forecast_mean</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num_steps_train</span> <span class="o">=</span> <span class="n">num_steps</span> <span class="o">-</span> <span class="n">num_steps_forecast</span>

    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">ground truth</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">forecast_steps</span> <span class="o">=</span> <span class="n">data_df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">forecast_start</span><span class="p">:].</span><span class="n">index</span>

    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">forecast_steps</span><span class="p">,</span> 
            <span class="n">forecast_samples</span><span class="p">.</span><span class="n">T</span><span class="p">,</span> 
            <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">forecast_steps</span><span class="p">,</span> 
            <span class="n">forecast_mean</span><span class="p">,</span> 
            <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
            <span class="n">ls</span><span class="o">=</span><span class="sh">'</span><span class="s">--</span><span class="sh">'</span><span class="p">,</span> 
            <span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">forecast</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">.</span><span class="nf">fill_between</span><span class="p">(</span><span class="n">forecast_steps</span><span class="p">,</span>
                   <span class="n">forecast_mean</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">forecast_scale</span><span class="p">,</span>
                   <span class="n">forecast_mean</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">forecast_scale</span><span class="p">,</span> 
                   <span class="n">color</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span> 
                   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">forecast_samples</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">forecast_samples</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">yrange</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylim</span><span class="p">([</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">yrange</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">yrange</span><span class="o">*</span><span class="mf">0.1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="nf">plot_forecast</span><span class="p">(</span>
    <span class="n">passengers</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">Passengers</span><span class="sh">'</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">1959-01-01</span><span class="sh">'</span><span class="p">,</span>
    <span class="n">forecast_mean</span><span class="p">,</span> 
    <span class="n">forecast_scale</span><span class="p">,</span> 
    <span class="n">forecast_samples</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="sh">'</span><span class="s">Airplane Passenger Numbers</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">"</span><span class="s">upper left</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Passenger Numbers</span><span class="sh">"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">"</span><span class="s">Month</span><span class="sh">"</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="nf">autofmt_xdate</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>---------------------------------------------------------------------------

NameError                                 Traceback (most recent call last)

&lt;ipython-input-4-d3135643ac66&gt; in &lt;module&gt;
     54     'Passengers',
     55     '1959-01-01',
---&gt; 56     forecast_mean,
     57     forecast_scale,
     58     forecast_samples,


NameError: name 'forecast_mean' is not defined
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>
